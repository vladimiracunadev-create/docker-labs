name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker info
        run: |
          docker version
          docker compose version

      # -----------------------
      # 01 - Node API
      # -----------------------
      - name: Build & test Node API
        working-directory: 01-node-api
        run: |
          docker build -t node-api .
          docker run -d -p 3000:3000 --name node-api-test node-api

          for i in {1..30}; do
            if curl -fsS http://localhost:3000 >/dev/null; then
              echo "Node OK"
              exit 0
            fi
            sleep 1
          done

          echo "Node no respondi贸"
          docker logs node-api-test || true
          exit 1

      - name: Cleanup Node
        if: always()
        run: |
          docker rm -f node-api-test || true

      # -----------------------
      # 03 - Python API
      # -----------------------
      - name: Build & test Python API
        working-directory: 03-python-api
        run: |
          docker build -t python-api .
          docker run -d -p 5000:5000 --name python-api-test python-api

          for i in {1..45}; do
            if curl -fsS http://localhost:5000 >/dev/null; then
              echo "Python OK"
              exit 0
            fi
            sleep 1
          done

          echo "Python no respondi贸"
          docker logs python-api-test || true
          exit 1

      - name: Cleanup Python
        if: always()
        run: |
          docker rm -f python-api-test || true

      # -----------------------
      # 02 - PHP LAMP (con Compose)
      # -----------------------
      - name: Build & test PHP LAMP (compose)
        working-directory: 02-php-lamp
        run: |
          docker compose up -d --build
          docker ps -a

          # Espera web (8080)
          for i in {1..60}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || true)
            if [ "$code" != "000" ]; then
              echo "Web HTTP $code"
              break
            fi
            sleep 2
          done

          # Acepta 2xx-4xx (si devuelve 5xx es error real)
          code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || true)
          if [ "$code" -ge 500 ] || [ "$code" = "000" ]; then
            echo "Web fall贸 (HTTP $code)"
            exit 1
          fi

          # phpMyAdmin (8081) suele responder 200/302, igual lo validamos sin exigir 200 exacto
          code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081 || true)
          if [ "$code" -ge 500 ] || [ "$code" = "000" ]; then
            echo "phpMyAdmin fall贸 (HTTP $code)"
            exit 1
          fi

      - name: Logs PHP LAMP (si falla)
        if: failure()
        working-directory: 02-php-lamp
        run: |
          docker compose ps || true
          docker compose logs --no-color --tail=250 || true

      - name: Cleanup PHP LAMP
        if: always()
        working-directory: 02-php-lamp
        run: |
          docker compose down -v --remove-orphans || true
